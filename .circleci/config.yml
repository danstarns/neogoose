version: 2.1
orbs:
  node: circleci/node@1.1.6
jobs:
  integration_tests:
    docker:
      - image: circleci/node:12.16.1
    working_directory: ~/repo
    steps:
      - setup_remote_docker
      - checkout
      - run:
          name: Start Docker Network
          command: docker network create neogoose
      - run:
          name: Start Neo4j
          command: docker run --name testneo4j --network conduit_network -p 7474:7474 -p 7687:7687 -d -v $HOME/neo4j/data:/data -v $HOME/neo4j/logs:/logs -v $HOME/neo4j/import:/var/lib/neo4j/import -v $HOME/neo4j/plugins:/plugins --env NEO4J_AUTH=neo4j/test neo4j:latest
      - run:
          name: Build image
          command: docker build -t integration-image -f ./Dockerfile.integration.test .
      - run:
          name: Run tests
          command: docker run --name intergration-container --network conduit_network -e NEO_USER=neo4j -e NEO_URL=bolt://host.docker.internal:7687/neo4j integration-image

workflows:
  version: 2
  master_default:
    jobs:
      - integration_tests:
          filters:
            branches:
              only: /master/
